---
title: "ã€Amazon SES/Goã€‘ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡è€…åã«æ—¥æœ¬èªã‚’å«ã‚ãŸã„"
emoji: "ğŸ“©"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","SES","Go"]
published: false
---

AWS SDK for Go ã‚’ä½¿ã£ã¦ Amazon SES ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã€é€ä¿¡è€…åã«å«ã‚ãŸæ—¥æœ¬èªãŒæ–‡å­—åŒ–ã‘ã—ã¦å›°ã£ãŸã®ã§è§£æ±ºæ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã™ã€‚
(æ—¥æœ¬èªã¨ã„ã†ã‹ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—ã§ã™)

## å…ˆã«çµè«–

`mime`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æ¬¡é …ä»¥é™ã§ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚‚ç´¹ä»‹ã—ã¤ã¤èª¬æ˜ã—ã¾ã™ã€‚
https://pkg.go.dev/mime

## ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãªã„ã¨ä½•ãŒèµ·ãã‚‹ã®ã‹

é€ä¿¡è€…åã‚’æŒ‡å®šã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®`Source`ãŒ`*string`ã ã£ãŸã®ã§ã€ä½•ã‚‚è€ƒãˆãšã«æ–‡å­—åˆ—ã‚’æ¸¡ã—ã¦å®Ÿè£…ã—ã¾ã—ãŸã€‚

```go:main.go
package main

import (
	"fmt"
	"os"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/session"
	"github.com/aws/aws-sdk-go/service/ses"
)

func main() {
	sess := session.Must(session.NewSession(&aws.Config{Region: aws.String("ap-northeast-1")}))
	svc := ses.New(sess)

	input := new(ses.SendEmailInput)

	// ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
	input.SetDestination(&ses.Destination{
		ToAddresses: []*string{
			aws.String("recipient@example.com"),
		},
	})

	input.SetMessage(&ses.Message{
		Body: &ses.Body{
			Text: &ses.Content{
				Data: aws.String("ã¼ã§ãƒ"),
			},
		},
		Subject: &ses.Content{
			Data: aws.String("ã•ã¶ã˜ã‡ãã¨"),
		},
	})

	// ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
	input.SetSource("ãã†ã—ã‚“ã—ã‚ƒ<sender@example.com>")

	_, err := svc.SendEmail(input)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
	fmt.Println("Success")
}
```

ã—ã‹ã—å±Šã„ãŸãƒ¡ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®ç”»åƒã®é€šã‚Šã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/f1f465d21dee-20220910.png)

ã“ã“ã§åƒ•ã¯ç”Ÿã¾ã‚Œã¦åˆã‚ã¦é€ä¿¡è€…åãŒæ–‡å­—åŒ–ã‘ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’ç›®ã«ã™ã‚‹ã®ã§ã—ãŸã€‚

## åŸå› ä¸¦ã³ã«è§£æ±ºæ³•ã®èª¿æŸ»

SDKã¯ã‚³ãƒ¡ãƒ³ãƒˆãŒã—ã£ã‹ã‚Šç›®ã«æ›¸ã„ã¦ã‚ã‚‹ã®ã§ä½•ã‹è§£æ±ºã®ç³¸å£ã¨ãªã‚‹ãƒ’ãƒ³ãƒˆã¯ãªã„ã‹ã¨ã€`Source`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã®é–¢é€£ãŒã‚ã‚Šãã†ãªéƒ¨åˆ†ã«ç›®ã‚’é€šã—ã¦ã¿ã¾ã™ã€‚

>(ä¸€éƒ¨ç•¥)
// Amazon SES does not support the SMTPUTF8 extension, as described in RFC6531
// (https://tools.ietf.org/html/rfc6531). For this reason, the local part of
// a source email address (the part of the email address that precedes the @
// sign) may only contain 7-bit ASCII characters (https://en.wikipedia.org/wiki/Email_address#Local-part).
// If the domain part of an address (the part after the @ sign) contains non-ASCII
// characters, they must be encoded using Punycode, as described in RFC3492
// (https://tools.ietf.org/html/rfc3492.html). The sender name (also known as
// the friendly name) may contain non-ASCII characters. These characters must
// be encoded using MIME encoded-word syntax, as described in RFC 2047 (https://tools.ietf.org/html/rfc2047).
// MIME encoded-word syntax uses the following form: =?charset?encoding?encoded-text?=.

https://pkg.go.dev/github.com/aws/aws-sdk-go/service/ses#SendEmailInput

æŠœç²‹éƒ¨åˆ†ã‚’ã¾ã¨ã‚ã‚‹ã¨ã€‚

- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒ¼ãƒˆ(`@`ã‚ˆã‚Šå‰)ã¯7-bit ASCIIã®ã¿å¯ã€‚
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆ(`@`ã‚ˆã‚Šå¾Œã‚)ã«éASCIIãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ã€Punycodeã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦æœ‰ã€‚
- é€ä¿¡è€…åã«éASCIIãŒå«ã¾ã‚Œã‚‹å ´åˆã¯MIMEã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦æœ‰ã€‚

MIMEã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸä¸Šã§`Source`ã«æ¸¡ã—ã¦ã‚ã’ã‚‹ã¨è‰¯ã•ãã†ã§ã™ã€‚

ã¾ãŸã‚³ãƒ¡ãƒ³ãƒˆã«URLãŒè¨˜è¼‰ã•ã‚Œã¦ã„ãŸ[RFC2047](https://www.rfc-editor.org/rfc/rfc2047)ã«ç›®ã‚’é€šã™ã¨ã€MIMEã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã®ä¸­ã§ã‚‚Qã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã¨Bã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å¯¾è±¡ã®æ–‡å­—åˆ—ã®ã»ã¨ã‚“ã©ãŒASCIIã®å ´åˆã«ã¯Qã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã€ãã†ã§ãªã‘ã‚Œã°Bã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã†ã¹ãã¨ã®ã“ã¨ã§ã™ã€‚

## å®Ÿè£…ã‚’ä¿®æ­£ã™ã‚‹

Goã§MIMEã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€`mime`ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ä»Šå›ã¯Bã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’é¸æŠã™ã‚‹ã®ã§ã€`WordEncoder`å‹ã®å®šæ•°`BEncoding`ã®`Encode`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ã¦ã€ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸæ–‡å­—åˆ—ã¨ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‘ãƒ¼ãƒˆã€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒ¼ãƒˆã‚’çµåˆã—ã¦`Source`ã«æ¸¡ã—ã¦ã‚ã’ã¾ã™ã€‚

```diff go:main.go
 package main
 
 import (
 	"fmt"
+	"mime"
 	"os"
 
 	"github.com/aws/aws-sdk-go/aws"
 	"github.com/aws/aws-sdk-go/aws/session"
 	"github.com/aws/aws-sdk-go/service/ses"
 )
 
 func main() {
 	sess := session.Must(session.NewSession(&aws.Config{Region: aws.String("ap-northeast-1")}))
 	svc := ses.New(sess)
 
 	input := new(ses.SendEmailInput)
 
 	// ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
 	input.SetDestination(&ses.Destination{
 		ToAddresses: []*string{
 			aws.String("recipient@example.com"),
 		},
 	})
 
 	input.SetMessage(&ses.Message{
 		Body: &ses.Body{
 			Text: &ses.Content{
 				Data: aws.String("ã¼ã§ãƒ"),
 			},
 		},
 		Subject: &ses.Content{
 			Data: aws.String("ã•ã¶ã˜ã‡ãã¨"),
 		},
 	})
 
 	// ã‚µãƒ³ãƒ—ãƒ«ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
+	encoded := mime.BEncoding.Encode("utf-8", "ãã†ã—ã‚“ã—ã‚ƒ")
+	source := encoded + "<sender@example.com>"
+	input.SetSource(source)
-	input.SetSource("ãã†ã—ã‚“ã—ã‚ƒ<sender@example.com>")
 
 	_, err := svc.SendEmail(input)
 	if err != nil {
 		fmt.Println(err)
 		os.Exit(1)
 	}
 	fmt.Println("Success")
 }
```

ã“ã¡ã‚‰ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c4d1a6c5e7a8-20220910.png)

ç„¡äº‹é€ä¿¡è€…åãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸã€‚


## ã¾ã¨ã‚

å®Ÿè£…ã™ã‚‹å‰ã«Godocã«ç›®ã‚’é€šãã†ã€‚

## å‚è€ƒ

- https://www.rfc-editor.org/rfc/rfc2047
- https://tools.ietf.org/html/rfc3492.html
- https://docs.aws.amazon.com/sdk-for-go/api/service/ses/#SendEmailInput
- https://docs.aws.amazon.com/ja_jp/ses/latest/dg/send-email-raw.html#send-email-raw-mime
- https://pkg.go.dev/mime
