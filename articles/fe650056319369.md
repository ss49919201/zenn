---
title: "MinIO on Docker Compose ã‚’è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸŒŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["MinIO"]
published: false
---

ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¨ã—ã¦S3ã‚’é¸æŠã—ãŸéš›ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã©ã†ã™ã‚‹ã‹ï¼Ÿã®ä¸€ã¤ã®è§£æ±ºæ‰‹æ®µã¨ã—ã¦ã€MinIO on Docker Composeã‚’è©¦ã—ã¦ã¿ãŸã€‚

- LocalStackã‚’ä½¿ã†
- å®Ÿéš›ã«AWSä¸Šã®S3ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹

ç­‰ã®æ‰‹æ®µã‚‚ã‚ã‚‹ã¨æ€ã†ãŒã€Goã§å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã¨èã„ã¦å˜ç´”ã«ä½¿ã£ã¦ã¿ãŸããªã£ãŸã¨ã„ã†çµŒç·¯ã§ã‚ã‚‹ã€‚

## ç’°å¢ƒ

- macOS Monterey 12.3.1
- Docker 20.10.10
- Docker Compose 2.1.1
- go1.18

## ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•

https://raw.githubusercontent.com/minio/minio/master/docs/orchestration/docker-compose/docker-compose.yaml ã‚’å‚è€ƒã«ã—ã¦docker-compose.ymlã«MinIOã®å®šç¾©ã‚’ã™ã‚‹ã€‚

```yml:docker-compose.yml
version: '3.9'

services:
  minio:
    image: quay.io/minio/minio:latest
    container_name: example-minio
    environment:
      MINIO_ROOT_USER: root
      MINIO_ROOT_PASSWORD: password
    command: server --console-address ":9001" /data
    ports:
      - 9000:9000
      - 9001:9001
```

`command`ã§ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚
`MINIO_ROOT_USER`ã¨`MINIO_ROOT_PASSWORD`ã¯ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã€APIå®Ÿè¡Œæ™‚ã«ä½¿ã†ã€‚

èµ·å‹•ã—ã¦ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã€‚

```sh
$ docker compose up -d
```

`localhost:9001`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/b7250a1e31b6-20220508.png)

`docker-compose.yml`ã«ã¦å®šç¾©ã—ãŸ`MINIO_ROOT_USER`ã¨`MINIO_ROOT_PASSWORD`ã‚’ãã‚Œãã‚Œå…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/c5f95a6040eb-20220508.png)

ã‚·ãƒ³ãƒ—ãƒ«ã§è‰¯ã„æ„Ÿã˜ã®UIã ã€‚

## ãƒã‚±ãƒƒãƒˆä½œæˆ

aws-sdk-goã®S3ã®APIã‚’ä½¿ã£ã¦ãƒã‚±ãƒƒãƒˆã‚’ä½œæˆã—ã¦ã¿ã‚‹ã€‚
ã›ã£ã‹ããªã®ã§ã€æŒ‡å®šã®ãƒã‚±ãƒƒãƒˆãŒæ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚Œã°ä¸€åº¦å‰Šé™¤ã—ã¦å†ä½œæˆã™ã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¨ã™ã‚‹ã€‚

```go:main.go
package main

import (
	"fmt"
	"os"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/awserr"
	"github.com/aws/aws-sdk-go/aws/credentials"
	"github.com/aws/aws-sdk-go/aws/session"
	"github.com/aws/aws-sdk-go/service/s3"
)

func main() {
	sess := session.Must(
		session.NewSession(
			&aws.Config{
				Credentials:      credentials.NewStaticCredentials("root", "password", ""),
				Endpoint:         aws.String("http://localhost:9000"),
				Region:           aws.String("ap-northeast-1"),
				S3ForcePathStyle: aws.Bool(true),
			}))
	svc := s3.New(sess)

	bucket := "example"

	exists, err := existsBucket(svc, bucket)
	if err != nil {
		fmt.Printf("failed to exists bucket: %s\n", err)
		os.Exit(1)
	}

	if exists {
		if err := deleteBucket(svc, bucket); err != nil {
			fmt.Printf("failed to delete bucket: %s\n", err)
			os.Exit(1)
		}
	}

	if err := createBucket(svc, bucket); err != nil {
		fmt.Printf("failed to create bucket: %s\n", err)
		os.Exit(1)
	}
}

func existsBucket(svc *s3.S3, bucket string) (bool, error) {
	_, err := svc.HeadBucket(&s3.HeadBucketInput{
		Bucket: aws.String(bucket),
	})
	if err != nil {
		if aerr, ok := err.(awserr.Error); ok {
			switch aerr.Code() {
			case "NotFound":
				return false, nil
			default:
				return false, err
			}
		} else {
			return false, err
		}
	}
	return true, nil
}

func deleteBucket(svc *s3.S3, bucket string) error {
	_, err := svc.DeleteBucket(&s3.DeleteBucketInput{
		Bucket: aws.String(bucket),
	})
	return err
}

func createBucket(svc *s3.S3, bucket string) error {
	_, err := svc.CreateBucket(&s3.CreateBucketInput{
		Bucket: aws.String(bucket),
	})
	return err
}
```

å°‘ã—ã ã‘ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‚’è§£èª¬ã™ã‚‹ã€‚

```go
	sess := session.Must(
		session.NewSession(
			&aws.Config{
				Credentials:      credentials.NewStaticCredentials("root", "password", ""),
				Endpoint:         aws.String("http://localhost:9000"),
				Region:           aws.String("ap-northeast-1"),
				S3ForcePathStyle: aws.Bool(true),
			}))
	svc := s3.New(sess)
```

`credentials.NewStaticCredentials`ã®ç¬¬ä¸€å¼•æ•°ãŒã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼IDã€ç¬¬äºŒå¼•æ•°ãŒã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã¨ãªã‚‹ãŒã€ã“ã“ã¯`docker-compose.yml`ã«ã¦å®šç¾©ã—ãŸ`MINIO_ROOT_USER`ã¨`MINIO_ROOT_PASSWORD`ã‚’æ¸¡ã™ã€‚
`Region`ã¯ã„ãã¤ã‹é©å½“ã«è©¦ã—ã¦ã¿ãŸã¨ã“ã‚ã€åˆ¥ã«ãªã‚“ã§ã‚‚ã„ã„ã£ã½ã„ã‘ã©æŒ‡å®šãŒãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
`S3ForcePathStyle`ã¯trueã«ã—ã¦ãŠã‹ãªã„ã¨ã€`http://{ãƒã‚±ãƒƒãƒˆå}.localhost:9000`ã¿ãŸã„ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã«ã„ã£ã¦ã—ã¾ã†ã€‚

```go
	_, err := svc.HeadBucket(&s3.HeadBucketInput{
		Bucket: aws.String(bucket),
	})
	if err != nil {
		if aerr, ok := err.(awserr.Error); ok {
			switch aerr.Code() {
			case "NotFound":
				return false, nil
			default:
				return false, err
			}
		} else {
			return false, err
		}
	}
	return true, nil
```

MinIOã¯é–¢ä¿‚ãªã„ï¼Ÿã‘ã©`HeadBucket`å®Ÿè¡Œæ™‚ã«ãƒã‚±ãƒƒãƒˆãŒãªã„ã¨ã€

```go
&s3err.RequestFailure{
  RequestFailure: &awserr.requestError{
    awsError: &awserr.baseError{
      code:    "NotFound",
      message: "Not Found",
      errs:    []error{},
    },
    statusCode: 404,
    requestID:  "16ED174B7BB404D8",
    bytes:      []uint8{},
  },
  hostID: "",
}
```

ã¿ãŸã„ãªã‚¨ãƒ©ãƒ¼ãŒè¿”ã£ã¦ãã‚‹ã€‚
aws-sdk-goã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ExampleãŒ

```go
svc := s3.New(session.New())
input := &s3.HeadBucketInput{
    Bucket: aws.String("acl1"),
}

result, err := svc.HeadBucket(input)
if err != nil {
    if aerr, ok := err.(awserr.Error); ok {
        switch aerr.Code() {
        case s3.ErrCodeNoSuchBucket:
            fmt.Println(s3.ErrCodeNoSuchBucket, aerr.Error())
        default:
            fmt.Println(aerr.Error())
        }
    } else {
        // Print the error, cast err to awserr.Error to get the Code and
        // Message from an error.
        fmt.Println(err.Error())
    }
    return
}

fmt.Println(result)
```
https://docs.aws.amazon.com/sdk-for-go/api/service/s3/#example_S3_HeadBucket_shared00

ã«ãªã£ã¦ã„ãŸã®ã§ã€æœ€åˆã¯`case "NotFound":`ã®éƒ¨åˆ†ã‚’`case s3.ErrCodeNoSuchBucket`ã§å®Ÿè£…ã—ã¦ã„ãŸã€‚
ãƒã‚±ãƒƒãƒˆãŒãªã„æ™‚ã«å…¨éƒ¨defaultã«å…¥ã£ã¦ã—ã¾ã£ã¦ä¸Šæ‰‹ãã„ã‹ãªã‹ã£ãŸã®ã§ã€ãƒ—ãƒªãƒ³ãƒˆãƒ‡ãƒãƒƒã‚°ã—ã¦ã‚¨ãƒ©ãƒ¼ã®å®Ÿä½“ã‚’ç¢ºèªã—`case "NotFound":`ã«æ›¸ãæ›ãˆãŸã€‚
(`NotFound`ã¯å®šæ•°åŒ–ã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚ã€‚ã€‚)

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚‹ã€‚

```sh
$ go run main.go
```

ç„¡äº‹ãƒã‚±ãƒƒãƒˆãŒã§ãã¦ã„ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/a89fe53754c7-20220508.png)

## ã¾ã¨ã‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã—ã£ã‹ã‚Šã—ã¦ã„ã¦ã‚ã¾ã‚Šèº“ãã“ã¨ãªãè©¦ã›ãŸã€‚
ã“ã‚Œã‹ã‚‰å€‹äººé–‹ç™ºã§ä½¿ã£ã¦ã„ã£ã¦ã‚‚ã„ã„ãªã¨æ€ã£ãŸã€‚

## å‚è€ƒ

- https://min.io/
- https://docs.aws.amazon.com/sdk-for-go/api/service/s3/
