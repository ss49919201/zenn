---
title: "ã€AWSã€‘StepFunctionsã§10é€£Lambda"
emoji: "ğŸ˜ƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","StepFunctions"]
published: true
---

StepFunctionsãªã‚‰é€£çµã•ã›ãŸLambdaãŒç®¡ç†ã—ã‚„ã™ã„ã¨èã„ã¦10å›ç¶šã‘ã¦Lamdaã‚’Invokeã—ã¦ã¿ã¾ã—ãŸã€‚

## StepFunctions ã¨ã¯

StepFunctionsã¯AWSã‚µãƒ¼ãƒ“ã‚¹ã‚’çµ„ã¿åˆã‚ã›ã€è¤‡æ•°ã®ã‚¹ãƒ†ãƒƒãƒ—ã§æ§‹æˆã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
å®Ÿè¡Œã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã®æ¡ä»¶åˆ†å²ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆãªã©ã‚’StepFunctionsã§å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã€ãã®çµæœãã‚Œãã‚Œã®ã‚¹ãƒ†ãƒƒãƒ—ãŒç®¡ç†ã—ã‚„ã™ã„ã‚‚ã®ã¨ãªã‚Šã¾ã™ã€‚
ãã‚Œãã‚Œã®ã‚¹ãƒ†ãƒƒãƒ—ã§ç”¨ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹è‡ªä½“ã«ã¯ãƒ­ã‚¸ãƒƒã‚¯ã ã‘ã‚’ä»»ã›ã€ã‚µãƒ¼ãƒ“ã‚¹é–“ã‚’ç–çµåˆã«ä¿ã¤ã“ã¨ãŒã§ããã†ã§ã™ã­ã€‚
ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ASL(Amazon States Language)ã¨å‘¼ã°ã‚Œã‚‹JSONå½¢å¼ã®è¨€èªã§å®šç¾©ã—ã€å®šç¾©ã•ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã¨å‘¼ã°ã‚Œã¾ã™ã€‚
ã¡ã‚‡ã£ã¨èª¿ã¹ãŸæ„Ÿã˜ã ã¨ASLã‚’JSONå½¢å¼ã§ã‚´ãƒªã‚´ãƒªæ›¸ãã®ã¯è¾›ãã†ã§ã™ã€‚
CDKã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ASLã«ã‚ãŸã‚‹éƒ¨åˆ†ã‚’ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§è¡¨ç¾ã™ã‚‹ã®ãŒæ¥½ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ã‚„ã£ã¦ã¿ã‚‹

ä»Šå›ã¯10é€£Lambdaã‚’å®Ÿè¡Œã™ã‚‹ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’CDKã‚’ä½¿ã£ã¦ä½œæˆã—ã¾ã™
CDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ä½œæ¥­ã¯å‰²æ„›ã—ã¾ã™ã€‚

ä»Šå›ä½œæˆã—ãŸStackã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
TypeScriptã§æ›¸ãã¾ã—ãŸã€‚
```typescript
export class StepFunctionsStack extends cdk.Stack {
  constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
    super(scope, id, props);

    const table = new ddb.Table(this, 'Table', {
      partitionKey: {
        name: 'ID',
        type: ddb.AttributeType.STRING,
      },
    });

    const putItem = new tasks.DynamoPutItem(this, 'PutItem', {
      table: table,
      item: {
        "ID": tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt('$.Payload.ID')),
        "Message": tasks.DynamoAttributeValue.fromString(sfn.JsonPath.stringAt('$.Payload.message')),
      },
    })

    const lambaFunc = new lambda.Function(this, 'Lambda Func', {
      runtime: lambda.Runtime.GO_1_X,
      handler: 'main',
      code: lambda.Code.asset('./lib/lambda')
    });

    const definition = new tasks.LambdaInvoke(this, `Invoke Lamda 1`, {
      lambdaFunction: lambaFunc,
      payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
    }).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 2`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 3`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 4`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 5`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 6`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 7`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 8`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 9`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).
      next(new tasks.LambdaInvoke(this, `Invoke Lamda 10`, {
        lambdaFunction: lambaFunc,
        payload: sfn.TaskInput.fromJsonPathAt('$.Payload')
      })).next(putItem)

    new sfn.StateMachine(this, 'StateMachine', {
      stateMachineName: 'StateMachine',
      definition: definition,
    })
  }
}
```

Lambdaã‹ã‚‰Lambdaã¸ã¨å€¤ã‚’æ¸¡ã—ã€æœ€å¾Œã«DynamoDBã«Putã™ã‚‹ã‚ˆã†ãªæ§‹æˆã«ãªã£ã¦ã„ã¾ã™ã€‚

`next()`ã§é€£çµã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã€LambdaãŒé€£ãªã£ã¦ã„ã‚‹éƒ¨åˆ†ã§ã™ã€‚
ã‚‚ã†ã¡ã‚‡ã£ã¨ã‚¹ãƒãƒ¼ãƒˆã«æ›¸ã‘ãã†ã§ã™ãŒã€ä¸€æ„ãªIDã‚’æŒ¯ã‚‰ãªã‘ã‚Œã°ã„ã‘ãªã‹ã£ãŸã“ã¨ã¨ã€ã¨ã«ã‹ã10é€£ã—ãŸã‹ã£ãŸã“ã¨ã‹ã‚‰ä»Šå›ã¯æ¨ªç€ã—ã¦ã„ã¾ã™ã€‚

Lambdaã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯Goã§æ›¸ã„ã¦ã„ã¾ã™ã€‚
å…¥åŠ›ã‚’ãã®ã¾ã¾å‡ºåŠ›ã¨ã—ã¦ã„ã‚‹ã ã‘ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§ã™ã€‚

```go
package main

import (
	"fmt"

	"github.com/aws/aws-lambda-go/lambda"
)

// å‹åã¯Payloadã˜ã‚ƒãªãã¦ã‚‚è‰¯ã„
type Payload struct {
	ID      string `json:"ID"`
	Message string `json:"message"`
}

func handler(p Payload) (Payload, error) {
	fmt.Printf(`"ID" is %v, "Message" is %v`, p.ID, p.Message)
	return p, nil
}

func main() {
	lambda.Start(decode)
}
```

Stackã‹ã‚‰ä½œæˆã•ã‚ŒãŸASLã‚‚è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```json
{
  "StartAt": "Invoke Lamda 1",
  "States": {
    "Invoke Lamda 1": {
      "Next": "Invoke Lamda 2",
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Type": "Task",
      "OutputPath": "$.Payload",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:stepFunctions-LambdaFunc75E80FD3-Hci23LRut7Xp",
        "Payload.$": "$"
      }
    },
    "Invoke Lamda 2": {
      "Next": "Invoke Lamda 3",
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Type": "Task",
      "OutputPath": "$.Payload",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:stepFunctions-LambdaFunc75E80FD3-Hci23LRut7Xp",
        "Payload.$": "$"
      }
    },
    .
    . çœç•¥
    .
    "Invoke Lamda 9": {
      "Next": "Invoke Lamda 10",
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Type": "Task",
      "OutputPath": "$.Payload",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:stepFunctions-LambdaFunc75E80FD3-Hci23LRut7Xp",
        "Payload.$": "$"
      }
    },
    "Invoke Lamda 10": {
      "Next": "PutItem",
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 6,
          "BackoffRate": 2
        }
      ],
      "Type": "Task",
      "OutputPath": "$.Payload",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "FunctionName": "arn:aws:lambda:ap-northeast-1:xxxxxxxxxxxx:function:stepFunctions-LambdaFunc75E80FD3-Hci23LRut7Xp",
        "Payload.$": "$"
      }
    },
    "PutItem": {
      "End": true,
      "Type": "Task",
      "Resource": "arn:aws:states:::dynamodb:putItem",
      "Parameters": {
        "Item": {
          "ID": {
            "S.$": "$.Payload.ID"
          },
          "Message": {
            "S.$": "$.Payload.message"
          }
        },
        "TableName": "stepFunctions-TableCD117FA1-1DYZ1NY76FLS7"
      }
    }
  }
}

```

æ¯ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã•ã‚Œã¦ã„ã‚‹`OutputPath`ã€`Parameters`ãŒé‡è¦ãªãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚
`OutputPath`ã§ã¯æ¬¡ã®é–¢æ•°(State)ã«æ¸¡ã™å€¤ã‚’æŒ‡å®šã—ã€`Parameters`ã§ã¯é–¢æ•°(State)ã§ä½¿ç”¨ã™ã‚‹å€¤ã‚’JSONå½¢å¼ã§æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
ã“ã®å®šç¾©ã«ã‚ˆã£ã¦é–¢æ•°ã®çµæœã‚’æ¬¡ã®é–¢æ•°ã«å¼•ãæ¸¡ã™ã¨ã„ã†ã“ã¨ãŒå®Ÿç¾ã§ãã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã™ã€‚
ã¾ãŸã€ä»Šå›ã¯CDKã§è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã¾ã¾ã«ã—ã¦ã„ã¾ã™ãŒã€å¤±æ•—æ™‚ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°ãªã©ã‚‚æŒ‡å®šã§ãã‚‹ã®ã§ã‚¨ãƒ©ãƒ¼ã«å‚™ãˆãŸæŸ”è»Ÿãªè¨­å®šã‚‚å¯èƒ½ã§ã™ã€‚ã‚„ã¯ã‚Šä¾¿åˆ©ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã­ã€‚

æœ€å¾Œã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ†ã‚¹ãƒˆã®JSONã‚’æ¸¡ã—ã¦å®Ÿè¡Œã—ã¦ã¿ã¾ã™ã€‚
ã„ã‚ˆã„ã‚ˆ10é€£LambdaãŒå§‹ã¾ã‚Šã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/53e9c3a58d43ce50653e6bc6.png)

ç„¡äº‹æˆåŠŸã—ãŸã‚ˆã†ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/94a853230356c969ad09ea81.png)

DynamoDBã«ã‚‚ã—ã£ã‹ã‚Šæ›¸ãè¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ecc2bef408ae48db71845c8c.png)

## ã•ã„ã”ã«

çµæ§‹æŸ”è»Ÿã«æ§˜ã€…ãªè¨­å®šãŒã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ã¡ã‚‡ã£ã¨éŠã‚“ã§ã¿ãŸã ã‘ã§ã™ãŒã€å®Ÿéš›ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ãƒãƒƒãƒå‡¦ç†ãªã‚“ã‹ã§ä½¿ãˆãã†ãªå°è±¡ã§ã™ã€‚
ãŸã ãŸã è¶£å‘³ã§æŠ€è¡“ã‚’è§¦ã£ã¦ã¿ã‚‹ã“ã¨ãŒã€æ¥­å‹™ã§ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®è²¢çŒ®ã«ç¹‹ãŒã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã®ã§ã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
ã“ã‚Œã‹ã‚‰ã‚‚æ¥­å‹™å¤–ã§ã¯éŠã³å¿ƒã‚’æŒã£ã¦å¤šãã®æŠ€è¡“ã«è§¦ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ããŸã„ãªã‚ã¨æ€ã„ã¾ã™ã€‚