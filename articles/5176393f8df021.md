---
title: "ã€Go/AWSã€‘Cognitoã®ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦ã¿ãŸ"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["AWS","Go"]
published: true
---

é–‹ç™ºç’°å¢ƒç”¨ã«Cognitoã®ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®AccessTokenãŒæ¬²ã—ã„ã“ã¨ãŒå¤šã€…ã‚ã‚‹ã€‚
ä¸€å›ä¸€å›UIã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã®ãŒé¢å€’ã ã£ãŸã®ã§ã€Goã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦ã¿ãŸã€‚

## å‹•ä½œç’°å¢ƒ

- macOS Catalina 10.17.7
- go1.16.5

## Cognitoã®è¨­å®š

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ¦ãƒ¼ã‚¶åã¨ã—ã¦ä½¿ç”¨
- ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®èªè¨¼ãƒ•ãƒ­ãƒ¼ã¯`ALLOW_ADMIN_USER_PASSWORD_AUTH`ã®ã¿ã‚’é¸æŠ
- èªè¨¼ã«ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯æ•°å­—ã€ç‰¹æ®Šæ–‡å­—ã€å¤§æ–‡å­—ã€å°æ–‡å­—ã§æ§‹æˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå¿…é ˆ
- ç®¡ç†è€…ã®ã¿ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆã‚’è¨±å¯

:::message
ä»Šå›ç´¹ä»‹ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸Šè¨˜ã®è¨­å®šã®ã¿ã§ã®å‹•ä½œæ¤œè¨¼ã—ã‹ã—ã¦ã„ãªã„ç‚ºã€ç•°ãªã‚‹è¨­å®šã®å ´åˆã¯æ­£ã—ãå‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒé«˜ã„
:::

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```go
package main

import (
	"crypto/hmac"
	"crypto/sha256"
	"encoding/base64"
	"flag"
	"fmt"
	"os"
	"time"

	"github.com/aws/aws-sdk-go/aws"
	"github.com/aws/aws-sdk-go/aws/session"
	"github.com/aws/aws-sdk-go/service/cognitoidentityprovider"
)

var (
	poolID       = "xxxxxxxxxxxxxxxxxxxxx"
	clientID     = "xxxxxxxxxxxxxxxxxxxxxxxxxx"
	clientSecret = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
)

func main() {
	sess := session.Must(session.NewSessionWithOptions(session.Options{
		SharedConfigState: session.SharedConfigEnable,
	}))
	cognitoClient := cognitoidentityprovider.New(sess)

	userName := flag.String("u", "", "user name")
	password := flag.String("p", "", "password")
	flag.Parse()

	if *userName == "" || *password == ""{
		fmt.Println("ivalid parameter")
		os.Exit(1)
	}

	newUserData := &cognitoidentityprovider.AdminCreateUserInput{
		UserPoolId:        &poolID,
		Username:          userName,
		TemporaryPassword: password,
	}

	_, err := cognitoClient.AdminCreateUser(newUserData)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	mac := hmac.New(sha256.New, []byte(clientSecret))
	mac.Write([]byte(*userName + clientID))
	secretHash := base64.StdEncoding.EncodeToString(mac.Sum(nil))

	initiateAuthOutput, err := cognitoClient.AdminInitiateAuth(&cognitoidentityprovider.AdminInitiateAuthInput{
		AuthFlow:   aws.String("ADMIN_USER_PASSWORD_AUTH"),
		UserPoolId: &poolID,
		ClientId:   &clientID,
		AuthParameters: map[string]*string{
			"USERNAME":    userName,
			"PASSWORD":    password,
			"SECRET_HASH": &secretHash,
		},
	})
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	respondToAuthChallengeOutput, err := cognitoClient.AdminRespondToAuthChallenge(&cognitoidentityprovider.AdminRespondToAuthChallengeInput{
		UserPoolId:    &poolID,
		ClientId:      &clientID,
		ChallengeName: aws.String("NEW_PASSWORD_REQUIRED"),
		ChallengeResponses: map[string]*string{
			"USERNAME":     userName,
			"NEW_PASSWORD": password,
			"SECRET_HASH":  &secretHash,
		},
		Session: initiateAuthOutput.Session,
	})
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	fmt.Println(*respondToAuthChallengeOutput.AuthenticationResult.AccessToken)
}

```

å…¨ä½“ã®æµã‚Œã¨ã—ã¦ã¯ã€
**æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ**
â†“
**èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹**
â†“
**ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—AccessTokenã‚’å–å¾—**
ã¨ãªã£ã¦ã„ã‚‹ã€‚
ãªãŠã€ä»Šå›ä½¿ç”¨ã™ã‚‹APIã¯å…¨ã¦ç®¡ç†è€…APIã§ã‚ã‚‹ã€‚

å°‘ã—ç´°ã‹ãè§£èª¬ã™ã‚‹ã€‚

### ãƒ¦ãƒ¼ã‚¶ãƒ¼æ–°è¦ä½œæˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã§å—ã‘å–ã‚Šã€æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã€‚
ãƒ€ãƒŸãƒ¼ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã®ã§ãã“ã¾ã§ã‚»ã‚­ãƒ¥ã‚¢ã«æ‰±ã‚ãªãã¦ã‚‚è‰¯ã„ã ã‚ã†ã¨ã„ã†ã“ã¨ã§ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ã‚’éè¡¨ç¤ºã«ã¯ã—ãªã„ã€‚


```go
	userName := flag.String("u", "", "user name")
	password := flag.String("p", "", "password")
	flag.Parse()

	if *userName == "" || *password == ""{
		fmt.Println("ivalid parameter")
		os.Exit(1)
	}

	newUserData := &cognitoidentityprovider.AdminCreateUserInput{
		UserPoolId:        &poolID,
		Username:          userName,
		TemporaryPassword: password,
	}

	_, err := cognitoClient.AdminCreateUser(newUserData)
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
```
### èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹

ä¸Šè¨˜ã§æ–°è¦ä½œæˆã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çŠ¶æ…‹ã¯`FORCE_CHANGE_PASSWORD`ã¨ãªã£ã¦ã„ã‚‹ã€‚
ã“ã®ã¾ã¾ã ã¨AccessTokenã¯å–å¾—ã§ããªã„ã€‚
èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹ã—ã¦åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°ã—ã€çŠ¶æ…‹ã‚’`CONFIRMED`ã«ã™ã‚‹ã“ã¨ã§AccessTokenãŒå–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
èªè¨¼ãƒ•ãƒ­ãƒ¼ã®é–‹å§‹ã¨ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ›´æ–°ã¯åˆ¥ã®APIã¨ãªã£ã¦ã„ã‚‹ã®ã§ã¾ãšã¯èªè¨¼ãƒ•ãƒ­ãƒ¼é–‹å§‹APIã‚’ä½¿ç”¨ã—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã€‚
èªè¨¼ãƒ•ãƒ­ãƒ¼é–‹å§‹APIã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‹ã‚‰ç”Ÿæˆã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚(ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ç”Ÿæˆã—ã¦ã„ãªã„å ´åˆã¯ãŠãã‚‰ãä¸è¦)

```go
	mac := hmac.New(sha256.New, []byte(clientSecret))
	mac.Write([]byte(*userName + clientID))
	secretHash := base64.StdEncoding.EncodeToString(mac.Sum(nil))

	initiateAuthOutput, err := cognitoClient.AdminInitiateAuth(&cognitoidentityprovider.AdminInitiateAuthInput{
		AuthFlow:   aws.String("ADMIN_USER_PASSWORD_AUTH"),
		UserPoolId: &poolID,
		ClientId:   &clientID,
		AuthParameters: map[string]*string{
			"USERNAME":    userName,
			"PASSWORD":    password,
			"SECRET_HASH": &secretHash,
		},
	})
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}
```

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—AccessTokenã‚’å–å¾—

èªè¨¼ãƒ•ãƒ­ãƒ¼é–‹å§‹ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹`session`ã‚’åˆ©ç”¨ã—ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã€‚
ãªãŠã€ã“ã®éš›ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨å…¨ä¸€è‡´ã—ã¦ã„ã¦ã‚‚å•é¡Œãªã„ã€‚(ã¡ã‚‡ã£ã¨æ°—æŒã¡æ‚ªã„ãŒãƒ€ãƒŸãƒ¼ãªã®ã§è‰¯ã—ã¨ã™ã‚‹)
ç„¡äº‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæˆåŠŸã™ã‚Œã°ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯å¾¡ç›®å½“ã¦ã®AccessTokenãŒå«ã¾ã‚Œã¦ã„ã‚‹ã€‚

```go
	respondToAuthChallengeOutput, err := cognitoClient.AdminRespondToAuthChallenge(&cognitoidentityprovider.AdminRespondToAuthChallengeInput{
		UserPoolId:    &poolID,
		ClientId:      &clientID,
		ChallengeName: aws.String("NEW_PASSWORD_REQUIRED"),
		ChallengeResponses: map[string]*string{
			"USERNAME":     userName,
			"NEW_PASSWORD": password,
			"SECRET_HASH":  &secretHash,
		},
		Session: initiateAuthOutput.Session,
	})
	if err != nil {
		fmt.Println(err)
		os.Exit(1)
	}

	fmt.Println(*respondToAuthChallengeOutput.AuthenticationResult.AccessToken)

```

## ã•ã„ã”ã«

æ¥½ã™ã‚‹ç‚ºã«ã•ãã£ã¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œã‚ã†ã¨è©¦ã¿ãŸãŒã€Cognitoã®ä»•æ§˜ãŒå…¨ç„¶åˆ†ã‹ã£ã¦ã„ãªã‹ã£ãŸç‚ºæ€ã£ãŸã‚ˆã‚Šã‚‚å¤§å¤‰ã ã£ãŸã€‚
Cognitoã«ã¤ã„ã¦ã»ã‚“ã®å°‘ã—è©³ã—ããªã‚ŒãŸã®ã§çµæœã‚ªãƒ¼ãƒ©ã‚¤ã¨ã™ã‚‹ã€‚

## å‚è€ƒ

https://dev.to/mcharytoniuk/using-aws-cognito-app-client-secret-hash-with-go-8ld
https://dev.classmethod.jp/articles/change-cognito-user-force_change_passwore-to-confirmed/
https://www.wakuwakubank.com/posts/696-aws-cognito/