---
title: "ã€AWSã€‘ECSã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’å–ã‚‹Lambdaã‚’ä½œæˆã™ã‚‹"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["awscdk","lambda","cloudwatch","fargate"]
published: true
---

# ã¯ã˜ã‚ã«

Fargateã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãŠä¸–è©±ã‚’ã›ãšã«ã€ã‚³ãƒ³ãƒ†ãƒŠã®é‹ç”¨ãŒã§ãã¦ä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚
ã—ã‹ã—ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ãƒ­ã‚°ã‚’è¦‹ã‚‰ã‚Œãªã„ã®ã§ã€ECSã‚¿ã‚¹ã‚¯ã®çŠ¶æ…‹å¤‰åŒ–ãŒè¿½ãˆãšå›°ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ã€Œã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ã™ã‚‹APIã¯å‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã¯ãšãªã®ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„â€¦ã€ãªã‚“ã¦ã¨ãã«ã¯ã€ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã®ã‹ã¯é—‡ã®ä¸­ã§ã™ã€‚

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€ECSã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’CloudWatch Eventsã§ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ã¦Lambdaã«æµã™ã“ã¨ã§ã€ã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°ã‚’å–ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã§ã™ã€‚
https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ecs_cwet.html

ä»Šå›ã¯â˜ï¸ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã€AWS CDKã§å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
CDKã¯TypeScriptã€Lambdaã®é–¢æ•°ã¯Goã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¾ã™

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³

- node 12.18.1
- go 1.17
- cdk 1.125.0 

# äº‹å‰ã«æº–å‚™ã—ã¦ãŠããƒªã‚½ãƒ¼ã‚¹

- ECS Cluster

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```sh
.
â”œâ”€â”€ lambda
â”‚   â”œâ”€â”€ go.mod
â”‚   â”œâ”€â”€ go.sum
â”‚   â””â”€â”€ main.go
â”œâ”€â”€ bin
â”‚   â””â”€â”€ cdk-app.ts
â”œâ”€â”€ lib
â”‚   â””â”€â”€ listen-ecs.ts
(ç•¥)
```

# CDKã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```typescript
import * as cdk from '@aws-cdk/core';
import * as targets from '@aws-cdk/aws-events-targets';
import * as events from '@aws-cdk/aws-events';
import * as lambda from '@aws-cdk/aws-lambda-go';


export class ListenEcsStack extends cdk.Stack {
    constructor(scope: cdk.Construct, id: string, props?: cdk.StackProps) {
        super(scope, id, props);
        const clusterArn = this.node.tryGetContext('cluster-arn')

        const fn = new lambda.GoFunction(this, 'listen-ecs-function', {
            functionName: 'listen-ecs-function',
            entry: 'lambda',
        })

        const targetFunction = new targets.LambdaFunction(fn)

        new events.Rule(this, 'EcsTaskChangeRule', {
            eventPattern: {
                source: ['aws.ecs'],
                detail: { 'clusterArn': [clusterArn] },
                detailType: ['ECS Task State Change']
            },
            targets: [targetFunction],
        });
    }
}
```

äº‹å‰ã«ä½œæˆã—ãŸECS Clusterã®ARNã‚’ã€`cdk.json`ã¾ãŸã¯ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¤–éƒ¨ã‹ã‚‰æ¸¡ã—ã¦ã‚ã’ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
Goã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦Lambdaã®é–¢æ•°ã‚’ä½œæˆã—ã€ä½œæˆã—ãŸé–¢æ•°ã‚’CloudWatch Eventsã®ãƒ«ãƒ¼ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã™ã‚‹ã“ã¨ã§ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹ã”ã¨ã«é–¢æ•°ã«ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ãŒæµã‚Œã¦ã„ãã¾ã™ã€‚
ãƒ«ãƒ¼ãƒ«ã®ã‚½ãƒ¼ã‚¹ã«ã¯`aws.ecs`ã‚’æŒ‡å®šã—ã€ç‰¹å®šã®ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®ã€ç‰¹å®šã®ã‚¿ã‚¹ã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ãƒãƒƒãƒã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¨­å®šã—ã¾ã™ã€‚

# Lambdaã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```go
package main

import (
	"context"
	"encoding/json"
	"fmt"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
)

func handler(ctx context.Context, event events.CloudWatchEvent) error {
	b, err := json.Marshal(event)
	if err != nil {
		return err
	}
	fmt.Println(string(b))
	return nil
}

func main() {
	lambda.Start(handler)
}
```

ãƒ«ãƒ¼ãƒ«ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹é–¢æ•°ã¯ã€ç™ºç”Ÿã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚’å—ã‘å–ã‚Šå‡¦ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã‚¤ãƒ™ãƒ³ãƒˆã¯`CloudWatchEvent`ã¨ã„ã†å‹ã®å€¤ã¨ã—ã¦ã€æµã‚Œã¦ãã¾ã™ã€‚
æ§‹é€ ä½“ã®ã¾ã¾å‡ºåŠ›ã™ã‚‹ã¨å°‘ã—è¦‹è¾›ã„ã®ã§ã€JSONã«å¤‰æ›ã—ã¦å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚

```go
type CloudWatchEvent struct {
	Version    string          `json:"version"`
	ID         string          `json:"id"`
	DetailType string          `json:"detail-type"`
	Source     string          `json:"source"`
	AccountID  string          `json:"account"`
	Time       time.Time       `json:"time"`
	Region     string          `json:"region"`
	Resources  []string        `json:"resources"`
	Detail     json.RawMessage `json:"detail"`
}
```

https://pkg.go.dev/github.com/aws/aws-lambda-go@v1.27.0/events#CloudWatchEvent

# ãƒ­ã‚°ç¢ºèª

é©å½“ã«ECSã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ã€å‡ºåŠ›ã•ã‚ŒãŸãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```
{
    "version": "0",
    "id": "44f7e6da-de4d-7a11-e35c-c0155c8be065",
    "detail-type": "ECS Task State Change",
    "source": "aws.ecs",
    "account": "xxxxxxxxxxx",
    "time": "2021-10-02T06:58:20Z",
    "region": "ap-northeast-1",
    "resources": [
        "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:task/sample/bb462024fc644eefbe5495695e405414"
    ],
    "detail": {
        "attachments": [
            {
                "id": "663cfa45-2caa-42df-ac53-26ea91c20a54",
                "type": "eni",
                "status": "PRECREATED",
                "details": [
                    {
                        "name": "subnetId",
                        "value": "subnet-6bae7040"
                    }
                ]
            }
        ],
        "availabilityZone": "ap-northeast-1d",
        "clusterArn": "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:cluster/sample",
        "containers": [
            {
                "containerArn": "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:container/sample/bb462024fc644eefbe5495695e405414/036b4462-e0c1-467b-9103-dec662299434",
                "lastStatus": "PENDING",
                "name": "sample",
                "image": "xxxxxxxxxxx.dkr.ecr.ap-northeast-1.amazonaws.com/repository:latest",
                "taskArn": "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:task/sample/bb462024fc644eefbe5495695e405414",
                "networkInterfaces": [],
                "cpu": "0"
            }
        ],
        "cpu": "256",
        "createdAt": "2021-10-02T06:58:20.45Z",
        "desiredStatus": "RUNNING",
        "enableExecuteCommand": false,
        "ephemeralStorage": {
            "sizeInGiB": 20
        },
        "group": "family:sample",
        "launchType": "FARGATE",
        "lastStatus": "PROVISIONING",
        "memory": "512",
        "overrides": {
            "containerOverrides": [
                {
                    "name": "sample"
                }
            ]
        },
        "platformVersion": "1.4.0",
        "taskArn": "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:task/sample/bb462024fc644eefbe5495695e405414",
        "taskDefinitionArn": "arn:aws:ecs:ap-northeast-1:xxxxxxxxxxx:task-definition/sample:6",
        "updatedAt": "2021-10-02T06:58:20.45Z",
        "version": 1
    }
}
```

æ§‹é€ ä½“ã‚’ãã®ã¾ã¾JSONã«å¤‰æ›ã—ãŸã®ã§æƒ…å ±é‡ãŒçµæ§‹å¤šã„ã§ã™ã­ã€‚
å®Ÿéš›ã®é‹ç”¨ã®éš›ã«ã¯é …ç›®ã‚’ç²¾æŸ»ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã®è¨˜è¼‰ã¯å‰²æ„›ã—ã¾ã™ãŒã€é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§çŠ¶æ…‹ãŒå¤‰åŒ–ã™ã‚‹ã”ã¨ã«ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

# ã•ã„ã”ã«

ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ã—ã¦ã„ã‚‹æ™‚ã“ãã€ãƒ­ã‚°ã‚„ã‚¢ãƒ©ãƒ¼ãƒ ã®è¨­å®šã‚’ã‚ˆã‚Šä¸å¯§ã«ã—ã¦ãŠãã“ã¨ãŒå¿…è¦ãªã®ã‹ãªã¨æ€ã£ã¦ã„ã¾ã™ã€‚
ãªã«ã‹ä¸å…·åˆãŒèµ·ã“ã£ãŸæ™‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒé›£ã—ã„ã“ã¨ã‚’è¸ã¾ãˆãŸä¸Šã§ã€ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã¨ä»˜ãåˆã£ã¦ã„ããŸã„æ‰€å­˜ã§ã‚ã‚Šã¾ã™ã€‚

# å‚è€ƒ

- https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/task-lifecycle.html
- https://dev.classmethod.jp/articles/ecs-state-change/
- https://docs.aws.amazon.com/ja_jp/AmazonECS/latest/developerguide/ecs_cwet.html
- https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html
- https://dev.classmethod.jp/articles/aws-lambda-go/