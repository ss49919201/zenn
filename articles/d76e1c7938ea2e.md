---
title: "aws-cdk-goã§EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãŸã¦ã‚‹"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Go","AWS","CDK"]
published: true
---

Goç‰ˆCDKãŒç™ºè¡¨ã•ã‚Œã¦1å¹´ãã‚‰ã„çµŒã¤ãŒå…¨ãè§¦ã‚Œã¦ã„ãªã‹ã£ãŸã®ã§ã€ç´ æŒ¯ã‚Šã¨ã—ã¦EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ãŸã¦ã¦ã¿ã‚‹ã€‚
ã¡ãªã¿ã«ã“ã‚Œã¾ã§ã‚‚CDKã¯ä½¿ã£ã¦ããŸã‘ã©ã€å…¨ã¦TypeScriptã§æ›¸ã„ã¦ã„ãŸã€‚

## å®Ÿè¡Œç’°å¢ƒ

- macOS Monterey 12.0.1
- cdk 2.19.0
- go1.18

## é››å½¢ã‚’ä½œã‚ã†

ã¾ãšã¯ `cdk init` ã™ã‚‹ã€‚

```sh
$ mkdir cdk-go-example
$ cdk init --language=go
```

ãƒ•ã‚¡ã‚¤ãƒ«ãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ã€‚

```sh
.
â”œâ”€â”€ README.md
â”œâ”€â”€ cdk-go-example.go
â”œâ”€â”€ cdk-go-example_test.go
â”œâ”€â”€ cdk.json
â””â”€â”€ go.mod
```

go.modã ã‘ä½œã£ã¦ãã‚Œã¦ã„ã‚‹ã®ã§ã€`go mod tidy`ã—ã¦ãŠãã€‚

```sh
$ go mod tidy
```

## Stackã‚’å®Ÿè£…ã—ã‚ˆã†

åˆæœŸåŒ–æ™‚ã«ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¹ã‚¿ãƒƒã‚¯ã®é››å‹ã¨ã‹ã‚‚ä½œã‚‰ã‚Œã‚‹ã€‚
ä»¥ä¸‹ã®é€šã‚Šã€‚(ã‚³ãƒ¡ãƒ³ãƒˆã¯å‰Šé™¤æ¸ˆã¿)

```go
package main

import (
	"github.com/aws/aws-cdk-go/awscdk/v2"
	"github.com/aws/constructs-go/constructs/v10"
)

type CdkGoExampleStackProps struct {
	awscdk.StackProps
}

func NewCdkGoExampleStack(scope constructs.Construct, id string, props *CdkGoExampleStackProps) awscdk.Stack {
	var sprops awscdk.StackProps
	if props != nil {
		sprops = props.StackProps
	}
	stack := awscdk.NewStack(scope, &id, &sprops)

	return stack
}

func main() {
	app := awscdk.NewApp(nil)

	NewCdkGoExampleStack(app, "CdkGoExampleStack", &CdkGoExampleStackProps{
		awscdk.StackProps{
			Env: env(),
		},
	})

	app.Synth(nil)
}

func env() *awscdk.Environment {
	return nil
}
```

`NewCdkGoExampleStack`ã«ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã‚’å®šç¾©ã—ã¦ã„ãæ„Ÿã˜ã¿ãŸã„ã€‚
https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2 ã‚’è¦‹ãªãŒã‚‰é€²ã‚ã‚‹ã€‚

### EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å®šç¾©ã—ã‚ˆã†

`awsec2.NewInstance`é–¢æ•°ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã‚‹ã€‚
ä»Šå›ã¯`t3.micro`ã®`AMAZON_LINUX_2`ã«ã™ã‚‹ã€‚

```go
func NewCdkGoExampleStack(scope constructs.Construct, id string, props *CdkGoExampleStackProps) awscdk.Stack {
	var sprops awscdk.StackProps
	if props != nil {
		sprops = props.StackProps
	}
	stack := awscdk.NewStack(scope, &id, &sprops)

	// EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
	awsec2.NewInstance(scope, jsii.String("ExampleInstance"), &awsec2.InstanceProps{
		InstanceType: awsec2.NewInstanceType(jsii.String("t3.micro")),
		MachineImage: awsec2.NewAmazonLinuxImage(&awsec2.AmazonLinuxImageProps{
			Generation: awsec2.AmazonLinuxGeneration_AMAZON_LINUX_2,
		}),
        
	})

	return stack
}
```

### VPCã‚’è¨­å®šã—ã‚ˆã†

å‰ç¯€ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ã¾ã¾`cdk deploy`ã‚³ãƒãƒ³ãƒ‰ã‚’å©ãã¨ã€panicã¨ãªã‚Šãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã™ã‚‹ã€‚

```sh
panic: "Missing required properties for aws-cdk-lib.aws_ec2.InstanceProps: vpc"
```

VPCã®æŒ‡å®šãŒå¿…é ˆã¨ä»°ã£ã¦ã„ã‚‹ã€‚
ç¢ºã‹ã«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’é…ç½®ã™ã‚‹VPCã‚’è‡ªå‹•ã§æ±ºå®šã•ã‚Œã‚‹ã¨å›°ã‚‹ã€‚
ã¨ã‚Šã‚ãˆãšã‚„ã£ã¦ã¿ãŸè¨˜äº‹ãªã®ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®VPCã‚’æŒ‡å®šã™ã‚‹ã€‚
`awsec2.Vpc_FromLookup`é–¢æ•°ã§æ—¢ã«å­˜åœ¨ã—ã¦ã„ã‚‹VPCã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã‚‹ã€‚
ä»Šå›ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆVPCã‚’ä½¿ã†ã®ã§ã€`awsec2.VpcLookupOptions`æ§‹é€ ä½“ã®`IsDefault`ã«boolå€¤trueã®ãƒã‚¤ãƒ³ã‚¿ã‚’æ¸¡ã™ã€‚
ã¾ãŸã€`awsec2.VpcLookupOptions`æ§‹é€ ä½“ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯`VpcName`ã‚„`VpcId`ã‚‚ã‚ã‚Šã€IDã‚„åå‰ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹æ§˜ã ã€‚

```go
func NewCdkGoExampleStack(scope constructs.Construct, id string, props *CdkGoExampleStackProps) awscdk.Stack {
	var sprops awscdk.StackProps
	if props != nil {
		sprops = props.StackProps
	}
	stack := awscdk.NewStack(scope, &id, &sprops)

	// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®VPCã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	defaultVpc := awsec2.Vpc_FromLookup(stack, jsii.String("DefaultVPC"), &awsec2.VpcLookupOptions{
		IsDefault: jsii.Bool(true),
	})

	// EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
	awsec2.NewInstance(stack, jsii.String("ExampleInstance"), &awsec2.InstanceProps{
		InstanceType: awsec2.NewInstanceType(jsii.String("t3.micro")),
		MachineImage: awsec2.NewAmazonLinuxImage(&awsec2.AmazonLinuxImageProps{
			Generation: awsec2.AmazonLinuxGeneration_AMAZON_LINUX_2,
		}),
		Vpc: defaultVpc,
	})

	return stack
}
```

## ç’°å¢ƒå€¤ã‚’è¨­å®šã—ã‚ˆã†

ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆå…ˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã€‚
é››å½¢ã¨ã—ã¦è‡ªå‹•ã§ä½œã‚‰ã‚ŒãŸ`env`é–¢æ•°ãŒã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®æƒ…å ±ã‚’æŒã£ãŸ`*awscdk.Environment`ã‚’è¿”ã™æ§˜ã«å®Ÿè£…ã™ã‚‹ã€‚
å€¤ã¯ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

```go
func env() *awscdk.Environment {
	return &awscdk.Environment{
		Account: jsii.String(os.Getenv("ACCOUNT_ID")),
		Region:  jsii.String(os.Getenv("REGION")),
	}
}

```

## å®Œæˆã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

```go
package main

import (
	"os"

	"github.com/aws/aws-cdk-go/awscdk/v2"
	"github.com/aws/aws-cdk-go/awscdk/v2/awsec2"
	"github.com/aws/constructs-go/constructs/v10"
	"github.com/aws/jsii-runtime-go"
)

type CdkGoExampleStackProps struct {
	awscdk.StackProps
}

func NewCdkGoExampleStack(scope constructs.Construct, id string, props *CdkGoExampleStackProps) awscdk.Stack {
	var sprops awscdk.StackProps
	if props != nil {
		sprops = props.StackProps
	}
	stack := awscdk.NewStack(scope, &id, &sprops)

	// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®VPCã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
	defaultVpc := awsec2.Vpc_FromLookup(stack, jsii.String("DefaultVPC"), &awsec2.VpcLookupOptions{
		IsDefault: jsii.Bool(true),
	})

	// EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
	awsec2.NewInstance(stack, jsii.String("ExampleInstance"), &awsec2.InstanceProps{
		InstanceType: awsec2.NewInstanceType(jsii.String("t3.micro")),
		MachineImage: awsec2.NewAmazonLinuxImage(&awsec2.AmazonLinuxImageProps{
			Generation: awsec2.AmazonLinuxGeneration_AMAZON_LINUX_2,
		}),
		Vpc: defaultVpc,
	})

	return stack
}

func main() {
	app := awscdk.NewApp(nil)

	NewCdkGoExampleStack(app, "CdkGoExampleStack", &CdkGoExampleStackProps{
		awscdk.StackProps{
			Env: env(),
		},
	})

	app.Synth(nil)
}

func env() *awscdk.Environment {
	return &awscdk.Environment{
		Account: jsii.String(os.Getenv("ACCOUNT_ID")),
		Region:  jsii.String(os.Getenv("REGION")),
	}
}
```

## ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

cdkã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã£ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
ã“ã“ã¯ä»–ã®è¨€èªã‚’é¸æŠã—ã¦ã„ã‚‹æ™‚ã¨å¤‰ã‚ã‚‰ãªã„ã€‚

```sh
$ cdk deploy
```

## å­˜åœ¨ç¢ºèª

é›‘ã ã‘ã©`LaunchTime`ã¨`InstanceType`ã‚’å–ã£ã¦å­˜åœ¨ç¢ºèªã™ã‚‹ã€‚

```sh
$ aws ec2 describe-instances --query 'Reservations[].Instances[].[LaunchTime, InstanceType]'
[
    [
        "2022-04-10T11:14:20.000Z", 
        "t3.micro"
    ]
]
```

ã§ãã¦ãŸğŸ†—

## æ‰€æ„Ÿ

ä»Šå›ã¯æœ¬å½“ã«è§¦ã‚Šãã‚‰ã„ã—ã‹æ›¸ã„ã¦ãªã„ä¸Šã«ã€TypeScriptã§æ›¸ãã“ã¨ã«æ…£ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‹ã‚‰ã¯å…¨éƒ¨Goã§æ›¸ã“ã†ï¼ã¨ã¾ã§ã¯æ€ã‚ãªã‹ã£ãŸã€‚ä»Šã¾ã§ä½œã£ãŸã“ã¨ã‚ã‚‹ãƒªã‚½ãƒ¼ã‚¹ãªã‚‰ã€TypeScriptã®æ–¹ãŒæ—©ãæ›¸ã‘ã‚‹ç­ˆã€‚
ãŸã ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã«é–¢ã—ã¦ã¯ã€Goã§æ›¸ã„ã¦ã¿ãŸã„ã¨ã„ã†æ€ã„ãŒã‚ã‚‹ã®ã§ã€Goã§CDKã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰æ›¸ã„ã¦ã¿ãŸçš„ãªè¨˜äº‹ã‚‚ä¸Šã’ã‚ˆã†ã¨è€ƒãˆã¦ã„ã‚‹ã€‚

## å‚è€ƒ

- https://aws.amazon.com/jp/blogs/developer/getting-started-with-the-aws-cloud-development-kit-and-go/
- https://docs.aws.amazon.com/ja_jp/cli/latest/userguide/cli-usage-filter.html